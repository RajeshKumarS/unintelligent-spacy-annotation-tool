<!DOCTYPE html>
<html>
    <head>
        <style>
            .entity_type {
                background-color: bisque;
                margin: 0 4px;
                padding: 4px;
                border-radius: 2px;
                cursor: pointer
            }
            code {
                display: inline-block; 
                background-color: rgb(248, 244, 244);
                padding:10px 5px;
                width: 700px; /* Whatever. The <code>'s width will change */
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
<body>

    <h1 style="text-align: center; color: #000; margin-bottom:50px; font-family: Arial, Helvetica, sans-serif">Un-intelligent Spacy Annotation Tool</h1>

    <p>
        <span class=entity_type style='background-color:goldenrod' onclick=set_entity_type(EntityType.GPE)>GPE</span>
        <span class=entity_type style='background-color: lawngreen' onclick=set_entity_type(EntityType.LOC)>LOC</span>
        <span class=entity_type style='background-color:mediumorchid' onclick=set_entity_type(EntityType.MONEY)>MONEY</span>
        <span class=entity_type style='background-color: navajowhite' onclick=set_entity_type(EntityType.NORP)>NORP</span>
        <span class=entity_type style='background-color: olive' onclick=set_entity_type(EntityType.ORG)>ORG</span>
        <span class=entity_type style='background-color:aqua' onclick=set_entity_type(EntityType.PERSON)>PERSON</span>
        <span class=entity_type style='background-color:rgb(137, 124, 167)' onclick=set_entity_type(EntityType.PRODUCT)>PRODUCT</span>
        <span class=entity_type style='background-color:lightgray; margin-left:170px; padding:4px 10px;' onclick=reset_all()>Reset All</span>
    </p>
    <textarea name="inputString" rows="4" cols="100" onpaste="reset_all()" onblur="label_output()" placeholder="keyin/paste your text here ..."></textarea>
    <div id="renderedView" style="margin:5px 0;"></div>
    <div id="labelContainer" style="margin-top:60px; width:710px;">
        <div style="padding:4px; font-family: Arial, Helvetica, sans-serif; font-weight:bold; font-size:medium">Training data:</div>
        <span style="float:right; padding:4px 8px; font-size:small; font-family: Arial, Helvetica, sans-serif; background-color: rgb(240, 235, 235); cursor:pointer;" onclick="copy_to_clipboard()">Copy</span><br>
        <code id="labeled"></code>
    </div>
    <div id ="rangeError" style="color: red; margin:10px 0">AnnotationError: index range overlap</div>

</body>
<script>
    var label = {"startIndex":0, "endIndex":0, "entitytType":0}
    var labelList = []
    var EntityType = {"NONE":0, "GPE":1, "LOC":2, "MONEY":3, "NORP":4, "ORG":5, "PERSON":6, "PRODUCT":7}
    var invertedEntityType = ["NONE", "GPE", "LOC", "MONEY", "NORP", "ORG", "PERSON", "PRODUCT"]
    var input_string = ""
    Object.freeze(EntityType)
    cursorStartPosition = 0
    cursorEndPosition = 0
    debug = 0

    function copy_to_clipboard()
    {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val($("#labeled").text()).select();
        document.execCommand("copy");
        $temp.remove();
    }

    // https://stackoverflow.com/questions/8837454/sort-array-of-objects-by-single-key-with-date-value
    function sortByKey(array, key) {
        return array.sort(function(a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    }

    function highlight(elem)
    {
        if (Boolean(debug)) console.log('highlight()');
        elem.style.backgroundColor = 'lightgray';
    }

    function dehighlight(elem)
    {
        if (Boolean(debug)) console.log('dehighlight()');
        elem.style.backgroundColor = 'white'
    }

    function removelabel(elem)
    {
        if (Boolean(debug)) console.log('removelabel()');
        labelList.splice($(elem).data("index"), 1)
        show_labels()
        $("#rangeError").hide()
        for (i=0; i<labelList.length-1; i++)
        {
            if (labelList[i].endIndex >= labelList[i+1].startIndex)
            {
                $("#rangeError").show()
            }     
        }
    }

    function show_labels()
    {
        if (Boolean(debug)) console.log('show_labels()');
        if (input_string.length == 0)
            return;
        $("#labelContainer").show()
        str = ''
        for (i=0; i<labelList.length; i++)
        {
            if (i != 0)
                str += ', '
            chunk = '<span data-index="' + i + '"style="padding:2px; border-radius:2px;" title="click to remove" onclick="removelabel(this)" onmouseover="highlight(this)"  onmouseout="dehighlight(this)">(' + labelList[i].startIndex + ', ' + labelList[i].endIndex + ', "' + invertedEntityType[labelList[i].entitytType] + '")</span>'
            str += chunk
        }
        output_string = '("' + input_string + '", [ ' + str + ' ] )'
        $("#labeled").html(output_string);
        /*
        if (labelList.length > 0) {
            $('#renderedView').text(input_string)
        }
        else
            $('#renderedView').text('')
        */    
   }

    function reset_all()
    {
        if (Boolean(debug)) console.log('reset_all()');
        labelList = []
        $("textarea[name=inputString]").val('')
        input_string = ''
        $("#labeled").html('');
        $("#rangeError").hide();
        $("#labelContainer").hide();
    }

    function set_entity_type(num)
    {
        if (Boolean(debug)) console.log('set_entity_type()');
        input_string = $("textarea[name=inputString]").val();
        cursorStartPosition = $('textarea[name=inputString]').prop("selectionStart");
        cursorEndPosition = $('textarea[name=inputString]').prop("selectionEnd");
        labelList.push({"startIndex":cursorStartPosition, "endIndex":cursorEndPosition, "entitytType":num})
        sortByKey(labelList, 'startIndex')
        for (i=0; i<labelList.length-1; i++)
        {
            if (labelList[i].endIndex >= labelList[i+1].startIndex)
            {
                $("#rangeError").show()
            }
        }
        show_labels()
    }

    function label_output()
    {
        if (Boolean(debug)) console.log('label_output()');

        input_string = $("textarea[name=inputString]").val()
        //output_string = '("' + input_string + '", [] )'
        if (input_string.length > 0) {
            //$("#labeled").text(output_string)
            $("#labelContainer").show();
        }
        else {
            //$("#labeled").text('');
            $("#labelContainer").hide();
        }

        cursorStartPosition = $('textarea[name=inputString]').prop("selectionStart")
        cursorEndPosition = $('textarea[name=inputString]').prop("selectionEnd")
        show_labels();
    }

    $(document).ready(function () {
        reset_all();
    });
</script>
</html>
