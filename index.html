<!DOCTYPE html>
<html>
    <head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130597273-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130597273-1');
</script>

        <style>
            html {
                display: table;
                margin: auto;
            }
            body {
                display: table-cell;
                vertical-align: middle;
            }
            textarea {
                resize: none;
                line-height: 16px;
                background-color: rgb(248, 244, 244);
                border:solid 1px lightgray;
            }
            code {
                display: inline-block; 
                background-color: rgb(248, 244, 244);
                padding:10px 5px;
                line-height: 20px;
                width: 700px; /* Whatever. The <code>'s width will change */
            }
            .entity_type_display {
                padding: 1px 2px;
                border-radius: 2px
            }
            .entity_type_button {
                background-color: bisque;
                margin: 0 4px;
                padding: 4px;
                border-radius: 2px;
                cursor: pointer
            }
            .bc_none {
                background-color:rgb(248, 244, 244)
            }
            .bc_gpe {
                background-color:goldenrod
            }
            .bc_loc {
                background-color: lawngreen
            }
            .bc_money {
                background-color: mediumorchid
            }
            .bc_norp {
                background-color:navajowhite
            }
            .bc_org {
                background-color: olive
            }
            .bc_person {
                background-color: aqua
            }
            .bc_product {
                background-color: rgb(137, 124, 167)
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
<body>

    <h2 style="text-align: center; color: #000; margin-bottom:75px; font-family: Arial, Helvetica, sans-serif">Un-intelligent Spacy Annotation Tool</h2>
    <p>
        <span class='entity_type_button bc_gpe' onclick=updateEntityType(EntityType.GPE)>GPE</span>
        <span class='entity_type_button bc_loc' onclick=updateEntityType(EntityType.LOC)>LOC</span>
        <span class='entity_type_button bc_money' onclick=updateEntityType(EntityType.MONEY)>MONEY</span>
        <span class='entity_type_button bc_norp' onclick=updateEntityType(EntityType.NORP)>NORP</span>
        <span class='entity_type_button bc_org' onclick=updateEntityType(EntityType.ORG)>ORG</span>
        <span class='entity_type_button bc_person' onclick=updateEntityType(EntityType.PERSON)>PERSON</span>
        <span class='entity_type_button bc_product' onclick=updateEntityType(EntityType.PRODUCT)>PRODUCT</span>
        <span class=entity_type style='background-color:lightgray; margin-left:170px; padding:4px 10px; cursor:pointer;' onclick=resetAll()>Reset All</span>
    </p>
    <textarea spellcheck="false" name="trainSentence" rows="5" cols="100" onpaste="resetAll()" onblur="onTrainDataBlur()" placeholder="keyin/paste training sentence here ..."></textarea>
    <div id="addHint" style="padding-left:4px; color:darkgrey; display:none; font-size:smaller;">Select text and click on entity type to annotate</div>
    <div id="labelContainer" style="margin-top:60px; width:710px; display:none;">
        <div style="padding:4px; font-family: Arial, Helvetica, sans-serif; font-weight:bold; font-size:medium">Training sentence with entity annotations:</div>
        <span style="float:right; padding:4px 8px; font-size:small; font-family: Arial, Helvetica, sans-serif; background-color: rgb(240, 235, 235); cursor:pointer;" onclick="copyToClipboard()">Copy</span><br>
        <code id="labeled"></code>
        <div id="deleteHint" style="margin-top:4px; padding-left:4px; color:darkgrey; display:none; font-size:smaller;">Click on annotation index range, e.g. (0, 5, "..."), to remove it</div>
    </div>
    <div id ="rangeError" style="color: red; margin:10px 0; display:none;">AnnotationError: index range overlap</div>

</body>
<script>
    var EntityType = {"NONE":0, "GPE":1, "LOC":2, "MONEY":3, "NORP":4, "ORG":5, "PERSON":6, "PRODUCT":7}
    Object.freeze(EntityType)
    var invertedEntityType = ["NONE", "GPE", "LOC", "MONEY", "NORP", "ORG", "PERSON", "PRODUCT"]
    var label = {"startIndex":0, "endIndex":0, "entityType":0}
    var labelList = []
    var label_chunks = []
    var train_sentence = ""
    var color_coded_string = ""
    cursorStartPosition = 0
    cursorEndPosition = 0
    debug = 0

    function copyToClipboard()
    {
        var $temp = $("<input>");
        $("body").append($temp);
        $temp.val($("#labeled").text()).select();
        document.execCommand("copy");
        $temp.remove();
    }

    // https://stackoverflow.com/questions/8837454/sort-array-of-objects-by-single-key-with-date-value
    function sortByKey(array, key) {
        return array.sort(function(a, b) {
            var x = a[key]; var y = b[key];
            return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        });
    }

    function highlight(elem)
    {
        if (Boolean(debug)) console.log('highlight()');
        elem.style.backgroundColor = 'lightgray';
    }

    function dehighlight(elem)
    {
        if (Boolean(debug)) console.log('dehighlight()');
        elem.style.backgroundColor = 'white'
    }

    function removeLabel(elem)
    {
        if (Boolean(debug)) console.log('removeLabel()');
        labelList.splice($(elem).data("index"), 1)
        showLabels()
        $("#rangeError").hide()
        for (i=0; i<labelList.length-1; i++)
        {
            if (labelList[i].endIndex >= labelList[i+1].startIndex)
            {
                $("#rangeError").show()
            }     
        }
    }

    function showLabels()
    {
        if (Boolean(debug)) console.log('showLabels()');
        if (train_sentence.length == 0)
            return;
        createLabelChunks();
        $("#labelContainer").show();
        $("#addHint").show();
        if (labelList.length > 0)
            $('#deleteHint').show();
        else
            $('#deleteHint').hide();
        str = ''
        for (i=0; i<labelList.length; i++)
        {
            if (i != 0)
                str += ', '
            chunk = '<span data-index="' + i + '"style="background-color: white; padding:2px; border-radius:2px; cursor:pointer;" title="click to remove" onclick="removeLabel(this)" onmouseover="highlight(this)"  onmouseout="dehighlight(this)">(' + labelList[i].startIndex + ', ' + labelList[i].endIndex + ', "' + invertedEntityType[labelList[i].entityType] + '")</span>'
            str += chunk
        }
        output_string = '("' + train_sentence + '", [ ' + str + ' ] )'
        output_string = '("' + color_coded_string + '", [ ' + str + ' ] )'
        $("#labeled").html(output_string);
    }

    function createLabelChunks()
    {
        label_chunks = [];
        ind_array = [];

        ind_array.push({'startIndex':0, 'entityType':'NONE'});
        for (i=0; i<labelList.length; i++) {
            ind_array.push({'startIndex':labelList[i].startIndex, 'entityType':labelList[i].entityType});
            ind_array.push({'startIndex':labelList[i].endIndex, 'entityType':0});
        }
        ind_array.push({'startIndex':train_sentence.length, 'entityType':0});
        for (i=0; i<ind_array.length-1; i++) {
            if (ind_array[i].startIndex == ind_array[i+1].startIndex)
                ind_array.splice(i,1);
        }
        for (i=0; i<ind_array.length-1; i++) {
            temp = train_sentence.slice(ind_array[i].startIndex, ind_array[i+1].startIndex);
            if (temp.length > 0)
                label_chunks.push({'chunk': temp, 'entityType': ind_array[i].entityType});
        }
        temp = '';
        classname = ''
        for (i=0; i<label_chunks.length; i++) {
            switch(label_chunks[i].entityType) {
                case 0: classname = 'bc_none'; break;
                case 1: classname = 'bc_gpe'; break;
                case 2: classname = 'bc_loc'; break;
                case 3: classname = 'bc_money'; break;
                case 4: classname = 'bc_norp'; break;
                case 5: classname = 'bc_org'; break;
                case 6: classname = 'bc_person'; break;
                case 7: classname = 'bc_product'; break;
            }
            temp += '<span class="entity_type_display ' + classname + '">' + label_chunks[i].chunk + '</span>';
        }
        color_coded_string = temp;
    }

    function updateEntityType(num)
    {
        if (Boolean(debug)) console.log('updateEntityType()');
        train_sentence = $("textarea[name=trainSentence]").val();
        cursorStartPosition = $('textarea[name=trainSentence]').prop("selectionStart");
        cursorEndPosition = $('textarea[name=trainSentence]').prop("selectionEnd");
        if (cursorStartPosition != cursorEndPosition) {
            labelList.push({"startIndex":cursorStartPosition, "endIndex":cursorEndPosition, "entityType":num})
            sortByKey(labelList, 'startIndex')
            for (i=0; i<labelList.length-1; i++)
            {
                if (labelList[i].endIndex >= labelList[i+1].startIndex)
                {
                    $("#rangeError").show()
                }
            }
        }
        $('textarea[name=trainSentence]').prop("selectionStart", 0);
        $('textarea[name=trainSentence]').prop("selectionEnd", 0);
        cursorStartPosition = 0;
        cursorEndPosition = 0;
        showLabels();
    }

    function onTrainDataBlur()
    {
        if (Boolean(debug)) console.log('onTrainDataBlur()');

        train_sentence = $("textarea[name=trainSentence]").val();
        if (train_sentence.length > 0) {
            $("#labelContainer").show();
        }
        else {
            $("#labelContainer").hide();
        }
        cursorStartPosition = $('textarea[name=trainSentence]').prop("selectionStart");
        cursorEndPosition = $('textarea[name=trainSentence]').prop("selectionEnd");
        showLabels();
    }

    function resetAll()
    {
        if (Boolean(debug)) console.log('resetAll()');
        labelList = []
        $("textarea[name=trainSentence]").val('')
        train_sentence = ''
        $("#labeled").html('');
        $("#rangeError").hide();
        $("#labelContainer").hide();
        $("#addHint").hide();
        labelList = []
        label_chunks = []
        train_sentence = ""
        color_coded_string = ""
        cursorStartPosition = 0
        cursorEndPosition = 0
    }

    $(document).ready(function () {
        resetAll();
    });
</script>
</html>
